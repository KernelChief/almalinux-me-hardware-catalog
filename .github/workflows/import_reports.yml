name: Hardware Report Intake (PR-gated)

on:
  issues:
    types: [opened]

jobs:
  process_report:
    # Only run for issues created with the "hardware-report" label (from your Issue Form)
    if: contains(github.event.issue.labels.*.name, 'hardware-report')
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract + validate JSON from Issue Form
        id: extract
        run: |
          # Grab the issue body from the event payload (Issue Form content is rendered into the body)
          jq -r '.issue.body' "$GITHUB_EVENT_PATH" > body_raw.txt
          tr -d '\r' < body_raw.txt > body.txt

          # Extract JSON from fenced ```json ... ``` block (preferred), else fallback to balanced braces
          python3 - <<'PY'
          import re, json, sys

          text = open("body.txt", "r", encoding="utf-8").read()

          # 1) Prefer fenced code block
          m = re.search(r"```(?:json)?\s*(\{.*?\})\s*```", text, flags=re.S)
          if m:
              candidate = m.group(1)
          else:
              # 2) Fallback: first balanced JSON object
              start = text.find("{")
              if start == -1:
                  raise SystemExit("No JSON object found in issue body. Paste full JSON in the form.")
              depth = 0
              in_str = False
              esc = False
              end = None
              for i, ch in enumerate(text[start:], start=start):
                  if in_str:
                      if esc:
                          esc = False
                      elif ch == "\\":
                          esc = True
                      elif ch == '"':
                          in_str = False
                  else:
                      if ch == '"':
                          in_str = True
                      elif ch == "{":
                          depth += 1
                      elif ch == "}":
                          depth -= 1
                          if depth == 0:
                              end = i + 1
                              break
              if end is None:
                  raise SystemExit("Could not find a complete JSON object in the issue body.")
              candidate = text[start:end]

          obj = json.loads(candidate)  # validate JSON
          rid = obj.get("report_id")
          if not rid or rid == "null":
              raise SystemExit("JSON is valid but missing required field: report_id")

          # Normalize output
          with open("temp_report.json", "w", encoding="utf-8") as f:
              json.dump(obj, f, indent=2)

          print(rid)
          PY

          REPORT_ID="$(jq -r '.report_id' temp_report.json)"
          echo "report_id=$REPORT_ID" >> "$GITHUB_OUTPUT"

      - name: Save report JSON
        run: |
          mkdir -p data/reports
          cp temp_report.json "data/reports/${{ steps.extract.outputs.report_id }}.json"

      - name: Rebuild DATABASE.md + UI index
        run: |
          # If you use the build_database.py we created earlier, it will generate:
          # - DATABASE.md
          # - docs/index.json
          python3 scripts/build_database.py

      - name: Create branch, commit, and push
        id: branch
        run: |
          BRANCH="report/${{ steps.extract.outputs.report_id }}-issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH"
      
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      
          git add "data/reports/${{ steps.extract.outputs.report_id }}.json" DATABASE.md docs/index.json
          git commit -m "Add hardware report ${{ steps.extract.outputs.report_id }} (pending approval)"
      
          git push --set-upstream origin "$BRANCH"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Open Pull Request (approval gate)
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const reportId = "${{ steps.extract.outputs.report_id }}";
            const branch = "${{ steps.branch.outputs.branch }}";
            const issueNumber = context.issue.number;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Hardware report ${reportId} (pending approval)`,
              head: branch,
              base: "main",
              body: [
                `This PR was generated automatically from issue #${issueNumber}.`,
                ``,
                `**Report ID:** \`${reportId}\``,
                `**Status:** Pending approval`,
                ``,
                `Merge this PR to publish the report into:`,
                `- \`data/reports/\``,
                `- \`DATABASE.md\``,
                `- \`docs/index.json\` (if enabled)`
              ].join("\n")
            });

            core.setOutput("pr_url", pr.data.html_url);

      - name: Comment back on the issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… **Report validated successfully.**\n\nðŸ§¾ A Pull Request has been opened for approval:\n${"${{ steps.pr.outputs.pr_url }}"}\n\nðŸ”’ This submission will only appear in the public database after the PR is merged.`
            });
