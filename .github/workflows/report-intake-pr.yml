name: Hardware Report Intake (PR-gated)

on:
  issues:
    types: [opened]

jobs:
  process_report:
    if: contains(github.event.issue.labels.*.name, 'hardware-report')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      workflows: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract + validate JSON from Issue Form
        id: extract
        run: |
          jq -r '.issue.body' "$GITHUB_EVENT_PATH" > body_raw.txt
          tr -d '\r' < body_raw.txt > body.txt

          python3 - <<'PY'
          import re, json, sys
          text = open("body.txt", "r", encoding="utf-8").read()
          m = re.search(r"```(?:json)?\s*(\{.*?\})\s*```", text, flags=re.S)
          if m:
              candidate = m.group(1)
          else:
              start = text.find("{")
              if start == -1:
                  raise SystemExit("No JSON found in issue body.")
              depth, in_str, esc, end = 0, False, False, None
              for i, ch in enumerate(text[start:], start=start):
                  if in_str:
                      if esc: esc = False
                      elif ch == "\\": esc = True
                      elif ch == '"': in_str = False
                  else:
                      if ch == '"': in_str = True
                      elif ch == "{": depth += 1
                      elif ch == "}":
                          depth -= 1
                          if depth == 0:
                              end = i + 1
                              break
              if end is None: raise SystemExit("Incomplete JSON.")
              candidate = text[start:end]
          obj = json.loads(candidate)
          rid = obj.get("report_id")
          if not rid: raise SystemExit("Missing report_id")
          with open("temp_report.json", "w", encoding="utf-8") as f:
              json.dump(obj, f, indent=2)
          PY

          REPORT_ID="$(jq -r '.report_id' temp_report.json)"
          echo "report_id=$REPORT_ID" >> "$GITHUB_OUTPUT"

      - name: Save report JSON
        run: |
          mkdir -p data/reports
          cp temp_report.json "data/reports/${{ steps.extract.outputs.report_id }}.json"

      - name: Build DATABASE.md
        run: |
          python3 - <<'PY'
          import json, os
          reports = []
          if os.path.exists('data/reports'):
              for f in os.listdir('data/reports'):
                  if f.endswith('.json'):
                      try:
                          with open(os.path.join('data/reports', f), 'r', encoding='utf-8') as j:
                              reports.append(json.load(j))
                      except: continue
          reports.sort(key=lambda x: x.get('timestamp', ''), reverse=True)
          with open('DATABASE.md', 'w', encoding='utf-8') as out:
              out.write('# ðŸ–¥ï¸ M&E Hardware Compatibility Database\n\n')
              out.write('> Generated automatically from approved reports.\n\n')
              out.write('| Date | ID | OS | CPU | GPU | Notes |\n')
              out.write('| :--- | :--- | :--- | :--- | :--- | :--- |\n')
              for r in reports:
                  date = (r.get('timestamp', 'N/A') or 'N/A')[:10]
                  rid = r.get('report_id', 'N/A')
                  os_rel = r.get('system', {}).get('os_release', 'Unknown')
                  cpu = r.get('processor', {}).get('model', 'Unknown')
                  gpus = r.get('graphics', []) or []
                  gpu_desc = gpus[0].get('device', 'N/A') if gpus else 'N/A'
                  notes = (r.get('user_notes', 'No notes') or 'No notes').replace('\n', ' ')
                  if len(notes) > 180: notes = notes[:180] + 'â€¦'
                  out.write(f'| {date} | `{rid}` | {os_rel} | {cpu} | {gpu_desc} | {notes} |\n')
          PY

      - name: Create branch, commit, and push
        id: branch
        run: |
          REPORT_ID="${{ steps.extract.outputs.report_id }}"
          BRANCH="report/${REPORT_ID}-issue-${{ github.event.issue.number }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b "$BRANCH"
          
          # Force clear any auto-generated files like docs/index.json
          git reset
          
          git add "data/reports/${REPORT_ID}.json" DATABASE.md
          
          # Crucial: Reset the workflows folder to exactly what is on main
          git checkout HEAD -- .github/workflows/
          
          git commit -m "Add hardware report ${REPORT_ID}"
          git push origin "$BRANCH" --force
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Open Pull Request
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Hardware report ${{ steps.extract.outputs.report_id }}`,
              head: "${{ steps.branch.outputs.branch }}",
              base: "main",
              body: `Generated from #${context.issue.number}`
            });
            core.setOutput("pr_url", pr.html_url);

      - name: Comment back on the issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… **Report validated.** PR opened: ${{ steps.pr.outputs.pr_url }}`
            });